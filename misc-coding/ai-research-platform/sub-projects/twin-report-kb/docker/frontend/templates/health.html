{% extends "base.html" %}

{% block title %}System Health - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
.health-container {
    max-width: 1200px;
    margin: 0 auto;
}

.service-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    overflow: hidden;
    transition: transform 0.2s ease;
}

.service-card:hover {
    transform: translateY(-2px);
}

.service-header {
    padding: 1rem 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.service-header.healthy {
    background: linear-gradient(135deg, #198754, #20c997);
    color: white;
}

.service-header.unhealthy {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
}

.service-header.unknown {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    color: white;
}

.service-body {
    padding: 1.5rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}

.status-indicator.healthy {
    background: #198754;
    box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.3);
}

.status-indicator.unhealthy {
    background: #dc3545;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
}

.status-indicator.unknown {
    background: #ffc107;
    box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.3);
}

.metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.metric-item {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    text-align: center;
    border: 1px solid #dee2e6;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #0d6efd;
    margin-bottom: 0.25rem;
}

.metric-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.response-time {
    font-size: 0.875rem;
    color: #6c757d;
}

.response-time.fast {
    color: #198754;
}

.response-time.slow {
    color: #ffc107;
}

.response-time.very-slow {
    color: #dc3545;
}

.error-log {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    max-height: 200px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.75rem;
}

.error-entry {
    padding: 0.5rem;
    border-bottom: 1px solid #dee2e6;
}

.error-entry:last-child {
    border-bottom: none;
}

.error-timestamp {
    color: #6c757d;
    margin-right: 0.5rem;
}

.error-level {
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-right: 0.5rem;
}

.error-level.error {
    background: #f8d7da;
    color: #721c24;
}

.error-level.warning {
    background: #fff3cd;
    color: #856404;
}

.error-level.info {
    background: #d1ecf1;
    color: #0c5460;
}

.refresh-button {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
}

.system-overview {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.overview-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.overview-stat {
    text-align: center;
}

.overview-stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.overview-stat-value.healthy {
    color: #198754;
}

.overview-stat-value.unhealthy {
    color: #dc3545;
}

.overview-stat-value.mixed {
    color: #ffc107;
}

.overview-stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.pulse {
    animation: pulse 2s infinite;
}
</style>
{% endblock %}

{% block content %}
<div class="health-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-heartbeat me-2"></i>System Health Monitor
                    </h1>
                    <p class="text-muted mb-0">Real-time service status and diagnostics</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="refreshHealth()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Overview -->
    <div class="system-overview">
        <h5 class="mb-3">
            <i class="fas fa-tachometer-alt me-2"></i>System Overview
        </h5>
        <div class="overview-stats">
            <div class="overview-stat">
                {% set healthy_count = services.values()|selectattr('status.value', 'equalto', 'healthy')|list|length %}
                {% set total_count = services|length %}
                <div class="overview-stat-value {{ 'healthy' if healthy_count == total_count else 'unhealthy' if healthy_count == 0 else 'mixed' }}">
                    {{ healthy_count }}/{{ total_count }}
                </div>
                <div class="overview-stat-label">Services Healthy</div>
            </div>
            <div class="overview-stat">
                {% set avg_response_time = (services.values()|selectattr('response_time', 'defined')|map(attribute='response_time')|list|sum / services.values()|selectattr('response_time', 'defined')|list|length) if services.values()|selectattr('response_time', 'defined')|list|length > 0 else 0 %}
                <div class="overview-stat-value {{ 'healthy' if avg_response_time < 100 else 'mixed' if avg_response_time < 500 else 'unhealthy' }}">
                    {{ "%.0f"|format(avg_response_time) }}ms
                </div>
                <div class="overview-stat-label">Avg Response Time</div>
            </div>
            <div class="overview-stat">
                <div class="overview-stat-value healthy">
                    {{ health.overall_status.value|title }}
                </div>
                <div class="overview-stat-label">Overall Status</div>
            </div>
            <div class="overview-stat">
                <div class="overview-stat-value">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="overview-stat-label">
                    Last Check: {{ health.timestamp.strftime('%H:%M:%S') }}
                </div>
            </div>
        </div>
    </div>

    <!-- Service Details -->
    <div class="row">
        {% for service_name, service_info in services.items() %}
        <div class="col-lg-6 mb-4">
            <div class="service-card">
                <div class="service-header {{ service_info.status.value }}">
                    <div>
                        <span class="status-indicator {{ service_info.status.value }}"></span>
                        <strong>{{ service_name|title|replace('_', ' ') }}</strong>
                    </div>
                    <div>
                        {% if service_info.response_time %}
                            <span class="response-time {{ 'fast' if service_info.response_time < 100 else 'slow' if service_info.response_time < 500 else 'very-slow' }}">
                                {{ "%.0f"|format(service_info.response_time) }}ms
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="service-body">
                    <!-- Status Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Status:</strong> 
                            <span class="badge bg-{{ 'success' if service_info.status.value == 'healthy' else 'danger' if service_info.status.value == 'unhealthy' else 'warning' }}">
                                {{ service_info.status.value|title }}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>Last Check:</strong> 
                            <small class="text-muted">{{ service_info.timestamp.strftime('%H:%M:%S') }}</small>
                        </div>
                    </div>

                    <!-- Service-specific metrics -->
                    {% if service_name == 'topic_manager' %}
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value">{{ "%.0f"|format(service_info.response_time or 0) }}</div>
                                <div class="metric-label">Response Time (ms)</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">{{ service_info.get('active_topics', 0) }}</div>
                                <div class="metric-label">Active Topics</div>
                            </div>
                        </div>
                    {% elif service_name == 'document_parser' %}
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value">{{ "%.0f"|format(service_info.response_time or 0) }}</div>
                                <div class="metric-label">Response Time (ms)</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">{{ service_info.get('documents_parsed', 0) }}</div>
                                <div class="metric-label">Documents Parsed</div>
                            </div>
                        </div>
                    {% elif service_name == 'quality_controller' %}
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value">{{ "%.0f"|format(service_info.response_time or 0) }}</div>
                                <div class="metric-label">Response Time (ms)</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">{{ service_info.get('checks_performed', 0) }}</div>
                                <div class="metric-label">Quality Checks</div>
                            </div>
                        </div>
                    {% elif service_name == 'diff_worker' %}
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value">{{ "%.0f"|format(service_info.response_time or 0) }}</div>
                                <div class="metric-label">Response Time (ms)</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">{{ service_info.get('analyses_completed', 0) }}</div>
                                <div class="metric-label">Analyses Done</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value">{{ "%.0f"|format(service_info.response_time or 0) }}</div>
                                <div class="metric-label">Response Time (ms)</div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Error Information -->
                    {% if service_info.error %}
                        <div class="alert alert-danger mb-0">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Error Details</h6>
                            <small class="font-monospace">{{ service_info.error }}</small>
                        </div>
                    {% endif %}

                    <!-- Service Actions -->
                    <div class="mt-3">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="testService('{{ service_name }}')">
                                <i class="fas fa-play me-1"></i>Test
                            </button>
                            <button class="btn btn-outline-secondary" onclick="viewServiceLogs('{{ service_name }}')">
                                <i class="fas fa-file-alt me-1"></i>Logs
                            </button>
                            {% if service_info.status.value == 'unhealthy' %}
                                <button class="btn btn-outline-warning" onclick="restartService('{{ service_name }}')">
                                    <i class="fas fa-redo me-1"></i>Restart
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- System Logs -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="service-card">
                <div class="service-header healthy">
                    <span><i class="fas fa-list-alt me-2"></i>Recent System Events</span>
                    <button class="btn btn-sm btn-outline-light" onclick="clearLogs()">
                        <i class="fas fa-trash me-1"></i>Clear
                    </button>
                </div>
                <div class="service-body">
                    <div class="error-log" id="systemLogs">
                        <!-- Mock log entries for demonstration -->
                        <div class="error-entry">
                            <span class="error-timestamp">{{ health.timestamp.strftime('%H:%M:%S') }}</span>
                            <span class="error-level info">INFO</span>
                            System health check completed successfully
                        </div>
                        <div class="error-entry">
                            <span class="error-timestamp">{{ (health.timestamp - timedelta(minutes=5)).strftime('%H:%M:%S') }}</span>
                            <span class="error-level info">INFO</span>
                            All services responding normally
                        </div>
                        {% if services.values()|selectattr('status.value', 'equalto', 'unhealthy')|list|length > 0 %}
                        <div class="error-entry">
                            <span class="error-timestamp">{{ (health.timestamp - timedelta(minutes=2)).strftime('%H:%M:%S') }}</span>
                            <span class="error-level error">ERROR</span>
                            Service connectivity issues detected
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Refresh Button -->
<button class="btn btn-primary refresh-button pulse" onclick="refreshHealth()" title="Auto-refresh enabled">
    <i class="fas fa-sync-alt"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh every 30 seconds
let autoRefreshInterval;

function startAutoRefresh() {
    autoRefreshInterval = setInterval(function() {
        refreshHealth();
    }, 30000); // 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

function refreshHealth() {
    // Show loading state
    const refreshBtn = document.querySelector('.refresh-button i');
    refreshBtn.classList.add('fa-spin');
    
    // Reload page to get fresh data
    setTimeout(function() {
        location.reload();
    }, 500);
}

function testService(serviceName) {
    showToast(`Testing ${serviceName}...`, 'info');
    
    // Simulate service test
    fetch(`/api/test-service/${serviceName}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${serviceName} test passed!`, 'success');
        } else {
            showToast(`${serviceName} test failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast(`Test failed: ${error.message}`, 'error');
    });
}

function viewServiceLogs(serviceName) {
    showToast(`Fetching logs for ${serviceName}...`, 'info');
    
    // Open logs in new window/modal
    window.open(`/api/service-logs/${serviceName}`, '_blank');
}

function restartService(serviceName) {
    if (confirm(`Are you sure you want to restart ${serviceName}?`)) {
        showToast(`Restarting ${serviceName}...`, 'info');
        
        fetch(`/api/restart-service/${serviceName}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`${serviceName} restarted successfully!`, 'success');
                setTimeout(refreshHealth, 2000);
            } else {
                showToast(`Restart failed: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            showToast(`Restart failed: ${error.message}`, 'error');
        });
    }
}

function clearLogs() {
    if (confirm('Are you sure you want to clear the system logs?')) {
        document.getElementById('systemLogs').innerHTML = 
            '<div class="error-entry"><span class="error-timestamp">' + 
            new Date().toLocaleTimeString() + 
            '</span><span class="error-level info">INFO</span>System logs cleared</div>';
        showToast('System logs cleared', 'success');
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.getElementById('liveToast');
    const toastBody = toast.querySelector('.toast-body');
    const toastIcon = toast.querySelector('.toast-header i');
    
    // Update content
    toastBody.textContent = message;
    
    // Update icon based on type
    toastIcon.className = `fas ${type === 'success' ? 'fa-check-circle text-success' : 
                                type === 'error' ? 'fa-exclamation-circle text-danger' : 
                                'fa-info-circle text-primary'} me-2`;
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});
</script>
{% endblock %} 